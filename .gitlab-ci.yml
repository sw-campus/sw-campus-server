stages:
  - validate
  - build
  - update-manifest

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  DOCKER_BUILDKIT: "0"

# Gradle 캐시 설정
.gradle-cache:
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - .gradle/caches
      - .gradle/wrapper


# Compile Check (MR 시)
compile:
  stage: validate
  image: eclipse-temurin:17-jdk
  extends: .gradle-cache
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  before_script:
    - apt-get update && apt-get install -y git
    - git config --global url."https://oauth2:${PROJECT_TOKEN}@gitlab.com/".insteadOf "https://gitlab.com/"
    - git submodule sync --recursive
    - git submodule update --init --recursive
  script:
    - chmod +x gradlew
    - ./gradlew compileJava compileTestJava


# DB Migration 검증
validate-migration:
  stage: validate
  image: eclipse-temurin:17-jdk
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - sw-campus-infra/db-postgres/src/main/resources/db/migration/**
    - if: $CI_COMMIT_BRANCH =~ /^(develop|main)$/
      changes:
        - sw-campus-infra/db-postgres/src/main/resources/db/migration/**
  before_script:
    - apt-get update && apt-get install -y git
  script:
    - |
      echo "마이그레이션 파일 변경 감지됨"
      echo "변경된 마이그레이션 파일:"
      git diff --name-only HEAD~1 HEAD -- 'sw-campus-infra/db-postgres/src/main/resources/db/migration/**' || true

      for file in sw-campus-infra/db-postgres/src/main/resources/db/migration/*.sql; do
        if [ -f "$file" ]; then
          filename=$(basename "$file")
          if [[ ! "$filename" =~ ^V[0-9]+__.*\.sql$ ]]; then
            echo "잘못된 파일명: $filename"
            echo "올바른 형식: V{번호}__{설명}.sql"
            exit 1
          fi
        fi
      done
      echo "모든 마이그레이션 파일명이 올바릅니다"


# Build Dev (develop 브랜치 전용)
build-dev:
  stage: build
  image: eclipse-temurin:17-jdk
  extends: .gradle-cache
  # Self-hosted Runner uses Docker socket binding (no DinD needed)
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "develop" && $CI_PIPELINE_SOURCE == "web"
      when: manual
  variables:
    TAG: "RHSA-$CI_COMMIT_SHA"
  before_script:
    - apt-get update && apt-get install -y git docker.io
    - git config --global url."https://oauth2:${PROJECT_TOKEN}@gitlab.com/".insteadOf "https://gitlab.com/"
    - git submodule sync --recursive
    - git submodule update --init --recursive
  script:
    - |
      echo "Building DEV image with tag $TAG"

      chmod +x gradlew
      ./gradlew build -x test

      docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
      docker build -t $IMAGE_NAME:$TAG .
      docker push $IMAGE_NAME:$TAG

      echo "IMAGE_TAG=$TAG" >> build.env
  artifacts:
    reports:
      dotenv: build.env

update-manifest-dev:
  stage: update-manifest
  image: alpine:latest
  needs:
    - job: build-dev
      artifacts: true
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  before_script:
    - apk add --no-cache git curl bash
  script:
    - |
      TAG="RHSA-$CI_COMMIT_SHA"

      git clone https://oauth2:${MANIFEST_TOKEN}@${CI_SERVER_HOST}/${MANIFEST_PROJECT_PATH}.git manifest
      cd manifest

      git config user.name "GitLab CI"
      git config user.email "gitlab-ci@${CI_SERVER_HOST}"
      git checkout develop

      # 수정된 sed 패턴: backend/server
      sed -i "/repository:.*backend\/server/,/pullPolicy:/ s|tag: \".*\"|tag: \"$TAG\"|" k8s/environments/develop/values.yaml

      git add .
      if git diff --staged --quiet; then
        echo "No changes to commit"
      else
        git commit -m "chore(server): update dev image to $TAG"
        git push origin develop
      fi


# Build Release (main 브랜치 전용)
build-release:
  stage: build
  image: eclipse-temurin:17-jdk
  extends: .gradle-cache
  # Self-hosted Runner uses Docker socket binding (no DinD needed)
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "web"
      when: manual
  before_script:
    - apt-get update && apt-get install -y git docker.io
    - git config --global url."https://oauth2:${PROJECT_TOKEN}@gitlab.com/".insteadOf "https://gitlab.com/"
    - git submodule sync --recursive
    - git submodule update --init --recursive
  script:
    - |
      CURRENT_VERSION=$(grep "applicationVersion=" gradle.properties | cut -d'=' -f2 | sed 's/-SNAPSHOT//')
      echo "Current version: $CURRENT_VERSION"

      MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
      MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
      PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
      NEW_PATCH=$((PATCH + 1))
      NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
      VERSION_TAG="v${NEW_VERSION}"

      echo "New version: $NEW_VERSION (tag: $VERSION_TAG)"
      echo "VERSION_TAG=$VERSION_TAG" >> build.env
      echo "NEW_VERSION=$NEW_VERSION" >> build.env

      sed -i "s/applicationVersion=.*/applicationVersion=${NEW_VERSION}-SNAPSHOT/" gradle.properties

      chmod +x gradlew
      ./gradlew build -x test

      docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
      docker build -t $IMAGE_NAME:$VERSION_TAG .
      docker push $IMAGE_NAME:$VERSION_TAG
  artifacts:
    reports:
      dotenv: build.env
    paths:
      - gradle.properties

commit-version-bump:
  stage: build
  image: alpine:latest
  needs:
    - job: build-release
      artifacts: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/
  before_script:
    - apk add --no-cache git
  script:
    - |
      git config user.name "GitLab CI"
      git config user.email "gitlab-ci@${CI_SERVER_HOST}"

      git remote set-url origin https://oauth2:${PROJECT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git

      git add gradle.properties
      git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
      git push origin HEAD:main

      git tag -f "$VERSION_TAG"
      git push origin "$VERSION_TAG" -f

update-manifest-release:
  stage: update-manifest
  image: alpine:latest
  needs:
    - job: build-release
      artifacts: true
    - job: commit-version-bump
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/
  before_script:
    - apk add --no-cache git curl bash
  script:
    - |
      git clone https://oauth2:${MANIFEST_TOKEN}@${CI_SERVER_HOST}/${MANIFEST_PROJECT_PATH}.git manifest
      cd manifest

      git config user.name "GitLab CI"
      git config user.email "gitlab-ci@${CI_SERVER_HOST}"
      git checkout release

      sed -i "/repository:.*backend\/server/,/pullPolicy:/ s|tag: \".*\"|tag: \"$VERSION_TAG\"|" k8s/environments/release/values.yaml

      git add .
      if git diff --staged --quiet; then
        echo "No changes to commit"
      else
        git commit -m "chore(server): update prod image to $VERSION_TAG"
        git push origin release
      fi
