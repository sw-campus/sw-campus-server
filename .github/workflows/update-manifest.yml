name: Update Manifest

on:
  workflow_run:
    workflows: ["Build Dev Image", "Build Release"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  update-manifest:
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      # 1) Server 레포 체크아웃 (태그 계산용)
      - name: Checkout server repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      # 2) 어떤 workflow에서 트리거되었는지 확인
      - name: Determine trigger source
        id: source
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.ref_name }}" = "main" ]; then
              echo "is_release=true" >> $GITHUB_OUTPUT
            else
              echo "is_release=false" >> $GITHUB_OUTPUT
            fi
          else
            WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
            echo "Triggered by: $WORKFLOW_NAME"
            
            if [ "$WORKFLOW_NAME" = "Build Release" ]; then
              echo "is_release=true" >> $GITHUB_OUTPUT
            else
              echo "is_release=false" >> $GITHUB_OUTPUT
            fi
          fi

      # 3) 이미지 태그 결정
      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SHA="${{ github.sha }}"
          else
            SHA="${{ github.event.workflow_run.head_sha }}"
          fi
          
          if [ "${{ steps.source.outputs.is_release }}" = "true" ]; then
            # Release workflow에서 트리거 → gradle.properties에서 버전 읽기
            VERSION=$(grep "applicationVersion=" gradle.properties | cut -d'=' -f2 | sed 's/-SNAPSHOT//')
            VERSION_TAG="v${VERSION}"
            echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT
            echo "Release tag: $VERSION_TAG"
          else
            # Build Dev Image (develop) → RHSA 태그
            echo "tag=RHSA-$SHA" >> $GITHUB_OUTPUT
            echo "Dev tag: RHSA-$SHA"
          fi

      # 4) 대상 manifest 브랜치 결정
      - name: Determine target manifest branch
        id: target
        run: |
          if [ "${{ steps.source.outputs.is_release }}" = "true" ]; then
            echo "branch=release" >> $GITHUB_OUTPUT
            echo "env=prod" >> $GITHUB_OUTPUT
          else
            echo "branch=develop" >> $GITHUB_OUTPUT
            echo "env=dev" >> $GITHUB_OUTPUT
          fi

      # 5) manifest 레포 체크아웃
      - name: Checkout manifest repo
        uses: actions/checkout@v4
        with:
          repository: sw-campus/sw-campus-manifest
          token: ${{ secrets.MANIFEST_REPO_TOKEN }}
          path: manifest

      # 6) Server 이미지 태그 변경
      - name: Update server image tag
        run: |
          cd manifest
          if [ "${{ steps.target.outputs.branch }}" == "develop" ]; then
            VALUES_FILE="k8s/environments/develop/values.yaml"
          else
            VALUES_FILE="k8s/environments/release/values.yaml"
          fi
          sed -i '/repository: ghcr.io\/sw-campus\/sw-campus-server$/,/pullPolicy:/ s|tag: ".*"|tag: "${{ steps.tag.outputs.tag }}"|' "$VALUES_FILE"

      # 7) PR 생성
      - name: Create PR to manifest repo
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MANIFEST_REPO_TOKEN }}
          path: manifest
          commit-message: "chore(server): update image (${{ steps.target.outputs.env }}) to ${{ steps.tag.outputs.tag }}"
          title: "Deploy Server (${{ steps.target.outputs.env }}) – ${{ steps.tag.outputs.tag }}"
          body: |
            - Service: Server
            - Environment: ${{ steps.target.outputs.env }}
            - Image tag: `${{ steps.tag.outputs.tag }}`
          base: ${{ steps.target.outputs.branch }}
          branch: chore/server-image-${{ steps.target.outputs.env }}-${{ steps.tag.outputs.tag }}
          delete-branch: true
          add-paths: |
            k8s/environments/develop/values.yaml
            k8s/environments/release/values.yaml
        continue-on-error: true
