name: Database Migration Check

on:
  push:
    branches:
      - develop
      - main
    paths:
      - 'sw-campus-infra/db-postgres/src/main/resources/db/migration/**'
  pull_request:
    branches:
      - develop
      - main
    paths:
      - 'sw-campus-infra/db-postgres/src/main/resources/db/migration/**'

jobs:
  validate-migration:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Validate migration files
      run: |
        echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ë³€ê²½ ê°ì§€ë¨"
        echo "ğŸ“ ë³€ê²½ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼:"
        git diff --name-only HEAD~1 HEAD -- 'sw-campus-infra/db-postgres/src/main/resources/db/migration/**' || true
        
    - name: Check migration naming
      run: |
        # ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ëª… ê·œì¹™ ê²€ì¦ (V{ë²ˆí˜¸}__{ì„¤ëª…}.sql)
        for file in sw-campus-infra/db-postgres/src/main/resources/db/migration/*.sql; do
          if [[ -f "$file" ]]; then
            filename=$(basename "$file")
            if [[ ! "$filename" =~ ^V[0-9]+__.*\.sql$ ]]; then
              echo "âŒ ì˜ëª»ëœ íŒŒì¼ëª…: $filename"
              echo "ì˜¬ë°”ë¥¸ í˜•ì‹: V{ë²ˆí˜¸}__{ì„¤ëª…}.sql"
              exit 1
            fi
          fi
        done
        echo "âœ… ëª¨ë“  ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ëª…ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤"

