name: Create Manifest PR (server)

on:
  workflow_run:
    workflows: ["Build Image"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  pr:
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    runs-on: ubuntu-latest

    steps:
      # 1) 서버 레포 체크아웃 (태그 계산용)
      - name: Checkout server repo
        uses: actions/checkout@v4

      # 2) 이미지 태그 계산
      # - main 브랜치: 버전 태그 (gradle.properties에서 읽기)
      # - develop 브랜치: 커밋 SHA
      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            SHA="${{ github.event.workflow_run.head_sha }}"
          else
            # workflow_dispatch → 현재 브랜치/커밋
            BRANCH="${{ github.ref_name }}"
            SHA="${{ github.sha }}"
          fi

          echo "Branch: $BRANCH"
          echo "SHA: $SHA"

          if [ "$BRANCH" = "main" ]; then
            # main 브랜치일 때는 gradle.properties에서 버전을 읽어서 버전 태그 사용
            if [ ! -f "gradle.properties" ]; then
              echo "Error: gradle.properties not found!"
              ls -la
              exit 1
            fi
            VERSION=$(grep "applicationVersion=" gradle.properties | cut -d'=' -f2 | sed 's/-SNAPSHOT//')
            VERSION_TAG="v${VERSION}"
            echo "Version: $VERSION"
            echo "Version tag: $VERSION_TAG"
            echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          else
            echo "tag=$SHA" >> $GITHUB_OUTPUT
          fi

      # 3) 대상 manifest 브랜치 결정 (dev / prod)
      # - server/develop → manifest/develop (VM)
      # - server/main    → manifest/main    (AWS)
      - name: Determine target manifest branch
        id: target
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            REF="${{ github.event.workflow_run.head_branch }}"
          else
            # workflow_dispatch → 현재 브랜치
            REF="${{ github.ref_name }}"
          fi

          if [ "$REF" = "develop" ]; then
            echo "branch=develop" >> $GITHUB_OUTPUT
            echo "env=dev" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "env=prod" >> $GITHUB_OUTPUT
          fi

      # 4) manifest 레포 체크아웃
      - name: Checkout manifest repo
        uses: actions/checkout@v4
        with:
          repository: sw-campus/sw-campus-manifest
          token: ${{ secrets.MANIFEST_REPO_TOKEN }}
          path: manifest

      # 5) server 이미지 태그 업데이트
      - name: Update server image tag
        run: |
          cd manifest
          # develop 브랜치면 develop 환경 values.yaml 업데이트
          if [ "${{ steps.target.outputs.branch }}" == "develop" ]; then
            VALUES_FILE="k8s/environments/develop/values.yaml"
          else
            VALUES_FILE="k8s/environments/release/values.yaml"
          fi
          sed -i '/repository: ghcr.io\/sw-campus\/sw-campus-server$/,/pullPolicy:/ s|tag: ".*"|tag: "${{ steps.tag.outputs.tag }}"|' "$VALUES_FILE"

      # 6) manifest 레포에 PR 생성 (환경별)
      - name: Create PR to manifest
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MANIFEST_REPO_TOKEN }}
          path: manifest
          commit-message: "chore(server): update image (${{ steps.target.outputs.env }}) to ${{ steps.tag.outputs.tag }}"
          title: "Deploy server image (${{ steps.target.outputs.env }}) ${{ steps.tag.outputs.tag }}"
          body: |
            - Environment: ${{ steps.target.outputs.env }}
            - Image tag: `${{ steps.tag.outputs.tag }}`
          base: ${{ steps.target.outputs.branch }}
          branch: chore/server-image-${{ steps.target.outputs.env }}-${{ github.run_id }}
          delete-branch: true
          add-paths: |
            k8s/environments/develop/values.yaml
            k8s/environments/release/values.yaml
        continue-on-error: true
