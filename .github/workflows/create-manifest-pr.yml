name: Create Manifest PR (server)

on:
  workflow_run:
    workflows: ["Build Image"]
    types:
      - completed

permissions:
  contents: read

jobs:
  pr:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1) 서버 레포 체크아웃 (태그 계산용)
      - name: Checkout server repo
        uses: actions/checkout@v4

      # 2) 이미지 태그 계산
      # - release 이벤트: 버전 태그
      # - 그 외(main/develop): 커밋 SHA
      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event.workflow_run.event }}" == "release" ]; then
            TAG="${{ github.event.workflow_run.release.tag_name }}"
            TAG="${TAG#v}"
          else
            TAG="${{ github.event.workflow_run.head_sha }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # 3) 대상 manifest 브랜치 결정 (dev / prod)
      # - server/develop → manifest/develop (VM)
      # - server/main    → manifest/main    (AWS)
      - name: Determine target manifest branch
        id: target
        run: |
          REF="${{ github.event.workflow_run.head_branch }}"

          if [ "$REF" == "develop" ]; then
            echo "branch=develop" >> $GITHUB_OUTPUT
            echo "env=dev" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "env=prod" >> $GITHUB_OUTPUT
          fi

      # 4) manifest 레포 체크아웃
      - name: Checkout manifest repo
        uses: actions/checkout@v4
        with:
          repository: sw-campus/sw-campus-manifest
          token: ${{ secrets.GH_MANIFEST_TOKEN }}
          path: manifest

      # 5) server 이미지 태그 업데이트
      - name: Update server image tag
        run: |
          cd manifest
          sed -i "s|image: .*sw-campus-server:.*|image: ghcr.io/sw-campus/sw-campus-server:${{ steps.tag.outputs.tag }}|g" \
            k8s/server/deployment.yaml

      # 6) manifest 레포에 PR 생성 (환경별)
      - name: Create PR to manifest
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_MANIFEST_TOKEN }}
          path: manifest
          commit-message: "chore(server): update image (${{ steps.target.outputs.env }}) to ${{ steps.tag.outputs.tag }}"
          title: "Deploy server image (${{ steps.target.outputs.env }}) ${{ steps.tag.outputs.tag }}"
          body: |
            - Environment: ${{ steps.target.outputs.env }}
            - Image tag: `${{ steps.tag.outputs.tag }}`
          base: ${{ steps.target.outputs.branch }}
          branch: chore/server-image-${{ steps.target.outputs.env }}-${{ steps.tag.outputs.tag }}
          add-paths: |
            k8s/server/deployment.yaml
